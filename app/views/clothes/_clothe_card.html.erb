<article class="relative isolate h-full flex flex-col rounded-2xl bg-white shadow-md overflow-hidden">
  <!-- header -->
  <div class="flex items-center gap-2 px-3 py-4">
    <% if clothe.user&.avatar&.attached? %>
        <%= image_tag clothe.user.avatar.variant(resize_to_fill: [32,32]),
                class: "h-8 w-8 rounded-full object-cover" %>
    <% else %>
    <div class="h-8 w-8 rounded-full bg-[#A85B5A]/20"></div>
    <% end %>

    <div class="leading-tight">
      <p class="font-medium"><%= "@#{clothe.user&.username || 'unknown'}" %></p>
    </div>
  </div>

  <!-- image -->
  <div class="relative">
    <% if clothe.photos.attached? %>
      <%= image_tag clothe.photos.first, class: "w-full object-cover aspect-[4/3] #{'grayscale' if clothe.dibbed?}" %>
    <% else %>
      <div class="w-full aspect-[4/3] bg-zinc-100"></div>
    <% end %>

    <% if clothe.dibbed? %>
      <div class="absolute inset-0 bg-zinc-200/50"></div>
      <div class="absolute inset-0 flex items-center justify-center">
        <span class="dibs-ribbon-anim uppercase tracking-widest font-extrabold text-[#A85B5A] text-3xl sm:text-5xl bg-white/70 px-3 py-1 rounded-lg shadow">
          CALLED DIBS
        </span>
      </div>
    <% end %>
  </div>

  <!-- body -->
  <div class="px-4 pb-4">
    <h2 class="mt-3 text-lg font-semibold flex items-center gap-2">
        <span><%= clothe.title %></span>
        <span class="text-sm text-zinc-500">Size: <%= clothe.size %></span>
    </h2>
    <p class="mt-1 text-sm text-zinc-600"><%= clothe.description %></p>

    <div class="mt-3 flex items-center justify-between">
      <span class="inline-flex items-center rounded-full bg-[#A85B5A]/10 text-[#A85B5A] px-2.5 py-1 text-xs">
        <%= clothe.item_type %> â€¢ <%= clothe.condition %>
      </span>

      <!-- actions -->
      <div class="relative z-50 pointer-events-auto flex items-center gap-3"
           onclick="event.stopPropagation(); event.stopImmediatePropagation();">

        <!-- View link -->
        <%= link_to "View", clothe_path(clothe),
              class: "text-sm font-medium text-[#A85B5A] hover:underline",
              onclick: "event.stopPropagation(); event.stopImmediatePropagation();" %>

        <% if user_signed_in? %>
          <% if clothe.dibbed? %>
            <% if clothe.dibbed_by == current_user || clothe.user == current_user %>
              <!-- Remove DIBS (caller OR owner) -->
              <form action="<%= undibs_clothe_path(clothe) %>" method="post" class="inline"
                    data-turbo="false"
                    onsubmit="event.stopPropagation(); event.stopImmediatePropagation();">
                <input type="hidden" name="_method" value="delete">
                <input type="hidden" name="authenticity_token" value="<%= form_authenticity_token %>">
                <button type="submit"
                        class="inline-flex items-center rounded-full bg-[#F4CDCD] px-3 py-1.5 text-[#A85B5A] text-sm shadow hover:bg-[#A85B5A] hover:text-white transition">
                  Remove Dibs
                </button>
              </form>
            <% end %>
          <% else %>
            <% unless clothe.user == current_user %>
              <!-- CALL DIBS (non-owner only) -->
              <form action="<%= dibs_clothe_path(clothe) %>" method="post" class="inline"
                    data-turbo="false"
                    onsubmit="event.stopPropagation(); event.stopImmediatePropagation();">
                <input type="hidden" name="authenticity_token" value="<%= form_authenticity_token %>">
                <button type="submit"
                        class="inline-flex items-center rounded-full bg-[#F4CDCD] px-3 py-1.5 text-[#A85B5A] text-sm shadow hover:bg-[#A85B5A] hover:text-white transition">
                  Call Dibs
                </button>
              </form>
            <% end %>
          <% end %>
        <% end %>
      </div>
    </div>
  </div>
</article>
