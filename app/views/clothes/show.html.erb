<div class="max-w-screen-lg mx-auto px-4 py-6">
  <!-- top bar: single back link + edit only for owner -->
    <div class="mb-4 flex items-center justify-between">
        <%= link_to "← Back", (request.referer || clothes_path), class: "text-[#A85B5A] hover:underline" %>

        <% if user_signed_in? && current_user.id == @item.user_id %>
            <%= link_to "Edit", edit_clothe_path(@item), class: "text-sm text-zinc-600 hover:underline" %>
    <% end %>
</div>


  <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
    <!-- LEFT: image gallery -->
    <div>
      <div class="w-full bg-white rounded-2xl shadow flex items-center justify-center aspect-[4/3] overflow-hidden">
        <% if @item.photos.attached? %>
          <%= image_tag @item.photos.first, id: "main-photo", class: "max-h-full max-w-full object-contain" %>
        <% else %>
          <div class="text-zinc-400">No photos</div>
        <% end %>
      </div>

      <% if @item.photos.attached? && @item.photos.count > 1 %>
        <div class="mt-3 grid grid-cols-5 gap-2">
          <% @item.photos.each_with_index do |photo, idx| %>
            <button
              class="aspect-square rounded-xl overflow-hidden bg-white border <%= idx.zero? ? 'ring-2 ring-[#A85B5A]' : 'border-zinc-200' %>"
              data-thumb="<%= url_for(photo) %>">
              <%= image_tag photo, class: "w-full h-full object-cover" %>
            </button>
          <% end %>
        </div>
      <% end %>
    </div>

    <!-- RIGHT: details -->
    <div class="rounded-2xl bg-white shadow px-6 py-6">
      <div class="flex items-center gap-3">
        <div class="h-8 w-8 rounded-full bg-[#A85B5A]/20"></div>
        <div class="leading-tight">
          <p class="font-medium"><%= "@#{@item.user&.username || 'unknown'}" %></p>
        </div>
      </div>

      <h1 class="mt-3 text-2xl font-semibold text-[#A85B5A]"><%= @item.title %></h1>
      <p class="mt-1 text-sm text-zinc-600"><%= @item.item_type %> • <%= @item.condition %> • Size <%= @item.size %></p>

      <div class="mt-4 prose max-w-none">
        <p><%= @item.description %></p>
      </div>

      <div class="mt-4 text-sm text-zinc-600">
        <span class="font-medium">Brand:</span> <%= @item.brand %>
      </div>

      <div class="mt-6 flex items-center gap-3">
        <%= link_to "Call dibs", "#",
            class: "inline-flex items-center rounded-full bg-[#A85B5A] px-4 py-2 text-white shadow hover:opacity-95" %>
        <%= link_to "Message", "#",
            class: "text-sm text-zinc-600 hover:underline" %>
      </div>
    </div>
  </div>

  <div class="mt-4 flex items-center gap-2">
  <% if user_signed_in? %>
    <% if @item.dibbed? %>
      <% if @item.dibbed_by == current_user || @item.user == current_user %>
        <!-- Release Dibs -->
        <form action="<%= undibs_clothe_path(@item) %>" method="post" class="inline" data-turbo="false">
          <input type="hidden" name="_method" value="delete">
          <input type="hidden" name="authenticity_token" value="<%= form_authenticity_token %>">
          <button type="submit"
                  class="inline-flex items-center rounded-full bg-[#F4CDCD] px-4 py-2 text-[#A85B5A] text-sm shadow hover:bg-[#A85B5A] hover:text-white transition">
            Release Dibs
          </button>
        </form>
      <% end %>
    <% else %>
      <% unless @item.user == current_user %>
        <!-- Call Dibs -->
        <form action="<%= dibs_clothe_path(@item) %>" method="post" class="inline" data-turbo="false">
          <input type="hidden" name="authenticity_token" value="<%= form_authenticity_token %>">
          <button type="submit"
                  class="inline-flex items-center rounded-full bg-[#F4CDCD] px-4 py-2 text-[#A85B5A] text-sm shadow hover:bg-[#A85B5A] hover:text-white transition">
            Call Dibs
          </button>
        </form>
      <% end %>
    <% end %>
  <% else %>
    <%= link_to "Log in to call dibs", new_user_session_path, class: "text-[#A85B5A] hover:underline" %>
  <% end %>
</div>


  <% if @more_from_user.present? %>
    <div class="mt-10">
      <h2 class="text-lg font-medium mb-3">More from <span class="text-[#A85B5A]">@<%= @item.user.username %></span></h2>
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
        <% @more_from_user.each do |clothe| %>
          <%= render partial: "clothes/clothe_card", locals: { clothe: clothe } %>
        <% end %>
      </div>
    </div>
  <% end %>
</div>
